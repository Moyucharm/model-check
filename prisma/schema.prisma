generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Channel {
  id        String      @id @default(cuid())
  name      String
  baseUrl   String      @map("base_url")
  apiKey    String      @map("api_key")
  proxy     String?
  enabled   Boolean     @default(true)
  sortOrder Int         @default(0) @map("sort_order")
  keyMode   String      @default("single") @map("key_mode")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @default(now()) @updatedAt @map("updated_at")
  models    Model[]
  channelKeys ChannelKey[]

  @@map("channels")
}

model Model {
  id            String          @id @default(cuid())
  channelId     String          @map("channel_id")
  modelName     String          @map("model_name")
  healthStatus  HealthStatus    @default(UNKNOWN) @map("health_status")
  lastStatus    Boolean?        @map("last_status")
  lastLatency   Int?            @map("last_latency")
  lastCheckedAt DateTime?       @map("last_checked_at")
  channelKeyId  String?         @map("channel_key_id")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @default(now()) @updatedAt @map("updated_at")
  checkLogs     CheckLog[]
  modelEndpoints ModelEndpoint[]
  channel       Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelKey    ChannelKey?     @relation(fields: [channelKeyId], references: [id], onDelete: SetNull)

  @@unique([channelId, modelName, channelKeyId])
  @@index([channelId])
  @@index([healthStatus])
  @@map("models")
}

model CheckLog {
  id              String          @id @default(cuid())
  modelId         String          @map("model_id")
  endpointType    EndpointType    @map("endpoint_type")
  status          CheckStatus
  latency         Int?
  statusCode      Int?            @map("status_code")
  errorMsg        String?         @map("error_msg")
  responseContent String?         @map("response_content")
  createdAt       DateTime        @default(now()) @map("created_at")
  model           Model           @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId, createdAt])
  @@index([createdAt])
  @@map("check_logs")
}

model ModelEndpoint {
  id              String       @id @default(cuid())
  modelId         String       @map("model_id")
  endpointType    EndpointType @map("endpoint_type")
  status          CheckStatus
  latency         Int?
  statusCode      Int?         @map("status_code")
  errorMsg        String?      @map("error_msg")
  responseContent String?      @map("response_content")
  checkedAt       DateTime     @default(now()) @map("checked_at")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @default(now()) @updatedAt @map("updated_at")
  model           Model        @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, endpointType])
  @@index([modelId])
  @@index([checkedAt])
  @@map("model_endpoints")
}

model SchedulerConfig {
  id                   String   @id @default("default")
  enabled              Boolean  @default(true)
  cronSchedule         String   @default("0 * * * *") @map("cron_schedule")
  timezone             String   @default("Asia/Shanghai")
  channelConcurrency   Int      @default(5) @map("channel_concurrency")
  maxGlobalConcurrency Int      @default(30) @map("max_global_concurrency")
  minDelayMs           Int      @default(3000) @map("min_delay_ms")
  maxDelayMs           Int      @default(5000) @map("max_delay_ms")
  detectAllChannels    Boolean  @default(true) @map("detect_all_channels")
  selectedChannelIds   Json?    @map("selected_channel_ids")
  selectedModelIds     Json?    @map("selected_model_ids")
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("scheduler_config")
}

model ChannelKey {
  id        String   @id @default(cuid())
  channelId String   @map("channel_id")
  apiKey    String   @map("api_key")
  name      String?
  lastValid     Boolean?  @map("last_valid")
  lastCheckedAt DateTime? @map("last_checked_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  models    Model[]

  @@map("channel_keys")
}

model ModelKeyword {
  id        String   @id @default(cuid())
  keyword   String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("model_keywords")
}

enum EndpointType {
  CHAT
  CLAUDE
  GEMINI
  CODEX
  IMAGE
}

enum CheckStatus {
  SUCCESS
  FAIL
}

enum HealthStatus {
  HEALTHY
  PARTIAL
  UNHEALTHY
  UNKNOWN
}
